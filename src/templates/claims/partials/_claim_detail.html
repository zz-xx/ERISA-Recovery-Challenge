{% load humanize %}
{% load claim_tags %}

<tr class="inserted-detail-row" hx-get="{% url 'claims:claim-detail' claim.id %}"
    hx-trigger="refresh-claim-detail-{{ claim.id }} from:body" hx-target="this" hx-swap="outerHTML">

    <td colspan="8" class="inserted-detail-row-td">
        <div class="grid detail-grid">

            <section>
                <article class="detail-card">
                    <header class="detail-header">
                        <h5>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Claim Details - {{ claim.id }}
                        </h5>
                        <span class="status-badge status-{{ claim.status|slugify }}">{{ claim.get_status_display }}</span>
                        {% include 'claims/partials/_flag_button.html' %}

                        
                    </header>

                    <div class="grid">
                        <div>
                            <label>Patient</label>
                            <strong>{{ claim.patient_name }}</strong>
                        </div>
                        <div>
                            <label>Discharge Date</label>
                            <strong>{{ claim.discharge_date }}</strong>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="detail-metric">
                            <label>Billed Amount</label>
                            <p>${{ claim.billed_amount|floatformat:2|intcomma }}</p>
                        </div>
                        <div class="detail-metric">
                            <label>Paid Amount</label>
                            <p
                                class="{% if claim.status == 'DENIED' %}text-danger{% elif claim.paid_amount > 0 %}text-success{% endif %}">
                                ${{ claim.paid_amount|floatformat:2|intcomma }}</p>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="cpt-codes-container">
                            <label>CPT Codes</label>
                            {% for code in claim.details.cpt_codes|split %}
                            <span class="cpt-code-tag">{{ code }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="grid">
                        <div>
                            <label>Insurer</label>
                            <strong>{{ claim.insurer_name }}</strong>
                        </div>
                        <div>
                            <label>Denial Reason</label>
                            {% if claim.details.denial_reason and claim.details.denial_reason != "N/A" %}
                            <strong class="denial-reason">{{ claim.details.denial_reason }}</strong>
                            {% else %}
                            <span class="text-muted">None</span>
                            {% endif %}
                        </div>
                    </div>
                </article>
            </section>

            <section>

                <article class="detail-card">
                    <header class="detail-header">
                        <h5>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                                <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
                            </svg>
                            Notes & Annotations
                        </h5>
                    </header>

                    <form hx-post="{% url 'claims:add-note' claim.id %}" hx-target="#notes-section-{{ claim.id }}"
                        hx-swap="innerHTML" class="add-note-form" hx-on::after-request="this.reset()">
                        {% csrf_token %}
                        <textarea id="note-textarea-{{claim.id}}" name="note" placeholder="Add a new note..."
                            required></textarea>
                        <button type="submit">Save Note</button>
                    </form>

                    <div id="notes-section-{{ claim.id }}">
                        {% include 'claims/partials/_notes_section.html' with notes=notes %}
                    </div>
                </article>
            </section>

        </div>
    </td>
</tr>
