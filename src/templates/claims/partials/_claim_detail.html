{% load humanize %}

<tr class="inserted-detail-row" 
    hx-get="{% url 'claims:claim-detail' claim.id %}"
    hx-trigger="refresh-claim-detail-{{ claim.id }} from:body" 
    hx-target="this" 
    hx-swap="outerHTML">

    <td colspan="8">
        <article>
            <header style="display: flex; align-items: center; justify-content: space-between;">
                <strong>Details for Claim #{{ claim.id }}</strong>
                {% if claim.is_flagged %}
                <span class="flag-indicator-large" title="This claim is flagged for review">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                        <line x1="4" y1="22" x2="4" y2="15"></line>
                    </svg>
                    Flagged by <strong>{{ claim.flagged_by.username|default:"Unknown" }}</strong> {{ claim.flagged_at|naturaltime }}
                </span>
                {% endif %}
            </header>
            
            <div class="grid">
                <div><strong>Patient:</strong> {{ claim.patient_name }}</div>
                <div><strong>Discharge Date:</strong> {{ claim.discharge_date }}</div>
            </div>

            <div class="grid">
                <div><strong>CPT Codes:</strong> {{ claim.details.cpt_codes }}</div>
                <div>
                    <strong>Denial Reason:</strong>
                    {% if claim.details.denial_reason and claim.details.denial_reason != "N/A" %}
                    {{ claim.details.denial_reason }}
                    {% else %}
                    <span style="color: var(--pico-muted-color);">None</span>
                    {% endif %}
                </div>
            </div>

            <footer>
                <div id="notes-section-{{ claim.id }}">
                    <h5>Notes</h5>
                    {% include 'claims/partials/_notes_section.html' with notes=notes %}
                </div>
            
                <form
                    hx-post="{% url 'claims:add-note' claim.id %}"
                    hx-target="#notes-section-{{ claim.id }}"
                    hx-swap="innerHTML"
                    class="add-note-form"
                    hx-on::after-request="this.reset()"
                >
                    {% csrf_token %}
                    <textarea name="note" placeholder="Add a new note..." required></textarea>
                    <button type="submit">Add Note</button>
                </form>
            </footer>

        </article>
    </td>
</tr>
