{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ERISA Recovery Claims{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Fira Sans + Fira Mono -->
    <link
        href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100..900;1,100..900&family=Fira+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />

    <style>
        :root {
            --pico-font-family: "Fira Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
        }

        /* --- Theme Color Override --- */
        /* This selector is specific enough to reliably override the CDN stylesheet. */
        html[data-theme="light"] {
            --pico-primary: #1e40af;
            --pico-primary-background: #dbeafe;
            --pico-primary-underline: #dbeafe;
            --pico-primary-hover: #1d4ed8;
            --pico-primary-focus: rgba(30, 64, 175, 0.25);
            --pico-primary-inverse: #fff;
        }

        /* --- Reusable Layout & Text Utilities --- */
        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--pico-muted-color);
        }

        .form-error {
            color: var(--pico-form-element-invalid-color);
        }

        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .gap-half {
            gap: 0.5rem;
        }

        .gap-1 {
            gap: 0.75rem;
        }

        .m-0 {
            margin: 0;
        }

        /* --- App-Specific Components --- */
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-actions form {
            margin: 0;
        }

        .nav-actions .logout-btn {
            padding: 0.5rem 1rem;
            margin: 0;
        }

        .login-card {
            max-width: 500px;
            margin: 4rem auto;
        }

        /* --- Filter Form --- */
        /* --- Filter Form --- */
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
            margin-bottom: 1.5rem;
        }

        .filter-container .search-field {
            flex-grow: 1;
            /* This makes the search bar take up the empty space */
        }

        .filter-container .controls {
            display: flex;
            gap: 1rem;
        }

        .filter-container input,
        .filter-container select,
        .filter-container label {
            margin-bottom: 0;
            /* Normalizes vertical alignment */
        }

        #flagged-filter {
            display: none;
        }

        .status-select-wrapper {
            position: relative;
        }

        .status-select-wrapper svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--pico-muted-color);
        }

        .status-select-wrapper select {
            padding-left: 2.25rem;
        }

        /* --- Table Enhancements --- */
        .table-container {
            overflow-x: auto;
        }

        tbody tr:not(.inserted-detail-row):hover {
            --pico-background-color: rgb(239 246 255 / 0.75);
        }

        .claim-id-link {
            font-family: "Fira Mono", monospace;
        }

        .actions-cell {
            display: flex;
            gap: 0.5rem;
        }

        .table-empty-state {
            text-align: center;
            padding: 3rem;
        }

        /* --- Detail View & Notes --- */
        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* --- Component Styles (Badges, Buttons, etc.) --- */
        .status-badge {
            padding: 0.4em 0.9em;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 0.375rem;
            color: #fff;
        }

        .status-paid {
            background-color: #28a745;
        }

        .status-denied {
            background-color: #dc3545;
        }

        .status-under-review {
            background-color: rgba(30, 64, 175, 0.600);
        }

        .action-btn {
            background: none;
            border: none;
            padding: 0.2rem;
            cursor: pointer;
            line-height: 0;
        }

        .action-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--pico-muted-color);
            stroke-width: 1.5;
            fill: none;
        }

        .action-btn:hover svg {
            stroke: var(--pico-primary-hover);
        }

        .action-btn.flag-btn svg {
            stroke: #dc3545;
        }

        .action-btn.flag-btn.flagged svg {
            fill: #dc3545;
            stroke: #dc3545;
        }

        #flagged-filter:checked+label {
            background-color: rgb(239 246 255 / 0.75);
            border-color: var(--pico-primary-border);
            color: var(--pico-primary);
        }

        #flagged-filter:checked+label svg {
            fill: #dc3545;
            stroke: #dc3545;
        }
    </style>

</head>

<body>
    <main class="container">
        <nav>
            <ul>
                <li><strong><a href="/">Claim Analysis Dashboard</a></strong></li>
            </ul>
            <ul>
                {% if user.is_authenticated %}
                <li>Hi, <strong>{{ user.username }}</strong></li>

                <li class="nav-actions">
                    <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="secondary outline"
                            style="padding: 0.5rem 1rem; margin: 0;">Logout</button>
                    </form>

                    <button
                        @click="document.documentElement.dataset.theme = (document.documentElement.dataset.theme === 'light' ? 'dark' : 'light')"
                        class="secondary outline" title="Toggle theme" x-data>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                </li>
                {% else %}
                <li>
                    <button
                        @click="document.documentElement.dataset.theme = (document.documentElement.dataset.theme === 'light' ? 'dark' : 'light')"
                        class="secondary outline" title="Toggle theme" x-data>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% block content %}{% endblock %}
    </main>

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>

        // standard Django-recommended script to get the CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Add the token to all HTMX POST, PUT, DELETE requests
        document.body.addEventListener('htmx:configRequest', (event) => {
            if (!['get', 'head', 'options', 'trace'].includes(event.detail.verb)) {
                event.detail.headers['X-CSRFToken'] = csrftoken;
            }
        });

        // script to handle detail view toggling
        document.body.addEventListener('htmx:beforeRequest', function (event) {
            const trigger = event.detail.elt;
            if (trigger.classList.contains('js-view-details-btn')) {
                const dataRow = trigger.closest('tr');
                const nextRow = dataRow.nextElementSibling;
                if (nextRow && nextRow.classList.contains('inserted-detail-row')) {
                    nextRow.remove();
                    event.preventDefault();
                }
            }
        });
    </script>
</body>

</html>